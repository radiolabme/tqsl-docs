services:
  # Development server with hot reload
  dev:
    build:
      context: ..
      dockerfile: .docker/Dockerfile
    volumes:
      - ..:/workspace:cached # Mount source code for editing
      - /workspace/node_modules # Anonymous volume prevents host node_modules
      - /workspace/dist # Anonymous volume prevents host dist
      - /workspace/.astro # Keep .astro in container too
    ports:
      - '${PORT:-4321}:4321'
    environment:
      - NODE_ENV=development
    networks:
      - tqsl-docs-net
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4321']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Production build and serve with Astro preview
  serve:
    build:
      context: ..
      dockerfile: .docker/Dockerfile
    volumes:
      - ..:/workspace:cached
      - /workspace/node_modules
      - /workspace/dist
      - /workspace/.astro
    ports:
      - '${PORT:-4321}:4321'
    environment:
      - NODE_ENV=production
    entrypoint: []
    command:
      - /bin/sh
      - -c
      - |
        echo "Installing dependencies..."
        npm ci --include=dev
        echo "Building site..."
        npm run build
        echo "Starting preview server..."
        npm run preview -- --host 0.0.0.0
    networks:
      - tqsl-docs-net
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4321']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # CI testing - runs lint, type-check, and build
  ci:
    build:
      context: ..
      dockerfile: .docker/Dockerfile
    volumes:
      - ..:/workspace:cached
      - /workspace/node_modules
      - /workspace/dist
      - /workspace/.astro
    environment:
      - CI=true
      - NODE_ENV=production
    entrypoint: []
    command:
      - /bin/sh
      - -c
      - |
        echo "Installing dependencies..."
        npm ci --include=dev
        echo "Running CI checks..."
        npm run ci
    networks:
      - tqsl-docs-net

networks:
  tqsl-docs-net:
    driver: bridge
